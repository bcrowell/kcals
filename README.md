kcals
=====

This software estimates your energy expenditure from running or walking,
based on a GPS track or a track generated by an application such as
google maps or mapmyrun. 

To download a track from mapmyrun: Pop up the route in your browser.
On the right-hand side of the screen, under ROUTE INFO, do Export this
Route. In the pop-up, click on the tab that says EXPORT AS KML, then
do DOWNLOAD KML FILE. 

The calorie expenditure is calculated from Minetti et al., http://jap.physiology.org/content/93/3/1039.full .
They got their data from elite mountain runners (all male) running on a treadmill.
The outputs seem low compared to other estimates I've seen. This may be because these
elite athletes were very efficient, were not carrying packs or wearing heavy boots, and
were running on a nice uniform treadmill. I find the data most useful if I want to compare
one run to another, e.g., if I want to know how a mountain run with lots of elevation gain
compares with a flat run at a longer distance.

## Use through the web interface

The web interface is available [here](http://www.lightandmatter.com/kcals)

## Use from the command line

synopsis:

`kcals.rb route.kml`

`kcals.rb filtering=600 weight=58 route.kml`

Total stats are written to standard output.

Also writes some spreadsheet data to profile.csv and path.csv.
The profile.csv file can be used to graph the elevation profile. 

## Input files

There is a wide variety of formats used by GPS units and applications such as Google Earth and MapMyRun.

Formats accepted are:

kml - the default

gpx

txt - the text format written by gpsvisualizer.com

csv - the unicsv format written by gpsbabel (or any CSV file with some of its columns labeled
Latitude, Longitude, and possibly Altitude)

If your data are not in one of these formats, you can convert them using gpsbabel, either on your
own machine or on the web service at gpsvisualizer.com/gpsbabel.

This kind of file can generally contain waypoints (named points of interest), a track (a list of points, often
from GPS measurements), or a route (a list of waypoints, which are usually goals, not actual spots you
visited). The data for input to this software must be in a track (not a route).
If you want to use a file that consists only of waypoints, use gpsbabel to convert it to
CSV format like this:

`gpsbabel -w -i kml -f foo.kml -o unicsv -F foo.csv`

However, this may give very inaccurate results if the real route is not well approximated by
straight line segments connecting the waypoints.

## Parameters and preferences

Preferences are read from the file ~/.kcals, but can be overridden from the command line
See the file sample_prefs for a sample preferences file.

Parameters are:

  metric -- 0 for US units, 1 for metric

  running -- 0 for walking, 1 for running

  weight -- body mass in kg

  filtering -- see below

  xy_filtering -- see below

  format -- see above for supported formats

  verbosity -- a level from 0 to 3

  dem -- 1 means try to download elevation data if it's not included in the input, 0 means don't

## Filtering

The parameters filtering and xy_filtering both represent horizontal distances
in units of meters. Their defaults values are 100 and 30, respectively. These are meant to get rid of bogus
oscillations in the data. Any elevation (z) changes that occur over horizontal distances less
than the value of "filtering" will tend to get filtered out, and likewise any horizontal motion that occurs
over horizontal distances less than the value of "xy_filtering."
To turn off filtering, set the relevant parameter to 0. 

The choice of the vertical filtering parameter
can have a huge effect on the total elevation gain, but the
effect on the calorie expenditure is usually fairly small.
There are several reasons why it may be a good idea to set a fairly large value of the vertical
("filtering") parameter:

 1. If the resolution of the horizontal track is poor, then it may appear to go up and down steep hillsides,
          when in fact the real road or trail contours around them.

 2. If elevations from GPS are being used (which is a bad idea), then random fluctuations in the GPS
          elevations can cause large errors.

 3. If the elevations are being taken from a digital elevation model (DEM), which is generally a good
         idea, then there may still be certain types of errors.
         Trails and roads are intentionally constructed so as not to go up and down steep hills. For instance,
         a road may cut straight through a hillside or even go through a tunnel, but this sort of information
         will not be present in the DEM. Or a road next to a big, steep hillside may show up on the DEM
         as having a incorrect, high elevation, because the resolution of the DEM (about 30 m for the one
         used by this software) is such that the hillside's elevation gets averaged in to the elevation
         of the road below.

The mileage derived from a GPS track can vary quite a bit depending on the resolution of the GPS data.
Higher resolution increases the mileage, because small wiggles get counted in. This has a big effect on
the energy calculation, because the energy is mostly sensitive to mileage, not gain.

## Adding elevation data

Many applications, such as mapmyrun, output tracks in KML format but set all the altitude data to
zero. To get around this, there are two options:

(1) Run the KML file through the filter at
http://www.gpsvisualizer.com/elevation . Under "output," select
"plain text." Run this software with format=text.

(2) Set dem=1, and if the software detects that elevation information is missing from the input
file, it will download it.

## Installing

### Minimal installation

apt-get install libjson-ruby gpsbabel

### To allow downloading of elevation data:

apt-get install libgdal-dev gdal-bin python-gdal python-pip

pip install elevation

### CGI

Edit the URL used in kcals.html to refer to kcals.cgi.

sudo make cgi
